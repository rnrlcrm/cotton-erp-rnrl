# Cloud Build Configuration for Cotton ERP
# Project: commodity-plafform-sandbox
# 
# Triggers on: Push to main/develop branches
# Builds: Backend + Frontend Docker images
# Deploys: Cloud Run services

steps:
  # ============================================================================
  # STEP 1: Build Backend Docker Image
  # ============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend'
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:$SHORT_SHA'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:latest'
      - '-f'
      - 'infra/docker/backend/Dockerfile.prod'
      - '.'
    timeout: '600s'

  # ============================================================================
  # STEP 2: Push Backend Image to Artifact Registry
  # ============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend'
    args:
      - 'push'
      - '--all-tags'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend'
    waitFor: ['build-backend']

  # ============================================================================
  # STEP 3: Build Frontend (React + Vite)
  # ============================================================================
  - name: 'node:18-alpine'
    id: 'build-frontend'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        cd frontend
        npm ci --prefer-offline --no-audit
        npm run build
    env:
      - 'VITE_API_URL=https://backend-service-565186585906.a.run.app'
      - 'NODE_ENV=production'
    timeout: '600s'

  # ============================================================================
  # STEP 4: Build Frontend Docker Image (Nginx)
  # ============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend-image'
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend:$SHORT_SHA'
      - '-t'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend:latest'
      - '-f'
      - 'infra/docker/frontend/Dockerfile.prod'
      - 'frontend'
    waitFor: ['build-frontend']

  # ============================================================================
  # STEP 5: Push Frontend Image
  # ============================================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend'
    args:
      - 'push'
      - '--all-tags'
      - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend'
    waitFor: ['build-frontend-image']

  # ============================================================================
  # STEP 6: Deploy Backend to Cloud Run
  # ============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-backend'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'backend-service'
      - '--image=us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:$SHORT_SHA'
      - '--region=us-central1'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--min-instances=0'
      - '--max-instances=3'
      - '--cpu=2'
      - '--memory=4Gi'
      - '--timeout=300'
      - '--concurrency=80'
      - '--port=8000'
      - '--vpc-connector=cotton-erp-connector'
      - '--set-env-vars=ENVIRONMENT=sandbox,LOG_LEVEL=INFO,GCP_PROJECT_ID=$PROJECT_ID'
      - '--set-secrets=DATABASE_URL=database-url:latest,REDIS_URL=redis-url:latest,JWT_SECRET_KEY=jwt-secret:latest,OPENAI_API_KEY=openai-key:latest'
      - '--service-account=backend-runtime@$PROJECT_ID.iam.gserviceaccount.com'
    waitFor: ['push-backend']
    timeout: '600s'

  # ============================================================================
  # STEP 7: Deploy Frontend to Cloud Run
  # ============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-frontend'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'frontend-service'
      - '--image=us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend:$SHORT_SHA'
      - '--region=us-central1'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--min-instances=0'
      - '--max-instances=2'
      - '--cpu=1'
      - '--memory=512Mi'
      - '--port=80'
    waitFor: ['push-frontend']
    timeout: '300s'

  # ============================================================================
  # STEP 8: Run Database Migrations
  # ============================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'run-migrations'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'jobs'
      - 'execute'
      - 'db-migrate'
      - '--region=us-central1'
      - '--wait'
    waitFor: ['deploy-backend']
    timeout: '600s'

  # ============================================================================
  # STEP 9: Health Check
  # ============================================================================
  - name: 'gcr.io/cloud-builders/curl'
    id: 'health-check'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        BACKEND_URL=$$(gcloud run services describe backend-service --region=us-central1 --format='value(status.url)')
        echo "Testing backend at: $$BACKEND_URL/health"
        curl -f "$$BACKEND_URL/health" || exit 1
        echo "âœ… Backend health check passed"
    waitFor: ['run-migrations']

# Build options
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  dynamicSubstitutions: true

# Timeout for entire build
timeout: 1800s

# Images to store in Artifact Registry
images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:$SHORT_SHA'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/backend:latest'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend:$SHORT_SHA'
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/cotton-erp/frontend:latest'
