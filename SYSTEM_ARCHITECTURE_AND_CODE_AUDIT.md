# System Architecture & Code Audit (Unified Baseline)

Date: 2025-12-02
Branch: `audit/full-code-verification`

## Purpose
This single document replaces all prior fragmented architecture / module / deployment / compliance markdown files. It is generated from code-level verification, not assumptions. Its goals:
- Provide one authoritative view of the current implemented system.
- Document verified runtime stack, data model, migrations baseline, and seed isolation flows.
- Define forward evolution boundaries (e.g. CDPS, AI orchestration) starting from a clean, unified async foundation.

## High-Level Architecture
- **Backend:** FastAPI modular monolith (moving toward domain boundaries), fully async SQLAlchemy 2.x + psycopg driver.
- **Database:** PostgreSQL. Clean Alembic baseline at `versions_clean/356fb34b6f4b_baseline_2025_12_02_clean.py`.
- **Caching / Queue (provisioned):** Redis (OTP, rate-limit, ephemeral locks), RabbitMQ (future Celery tasks). Currently minimal usage for OTP & potential background tasks.
- **Frontend:** (Present but not audited here) – dev container for a Vite/React app pointing to `8000` backend.
- **Observability:** OpenTelemetry scaffold present; disabled for boot performance until instrumentation plan finalized.
- **Async Only:** Legacy sync `SessionLocal` and duplicate Base definitions removed; canonical `backend/db/base.py` supplies `Base`.

## Core Modules (Implemented / Foundational)
| Domain | Status | Notes |
| ------ | ------ | ----- |
| Settings (Organization, Locations, Commodities) | Active | Provides foundational referential data. |
| Partners (BusinessPartner, Onboarding, Locations, Employees) | Unified | Consolidated onto canonical `BusinessPartner` model. |
| Trade Desk (Availability, Requirement) | Present | Needs performance indices reintroduction post profiling. |
| Auth / Security (Users, Roles, Permissions, Refresh Tokens) | Active | Token schemas standardized. OTP flows seeded. |
| Events / Outbox | Active | Event sourcing/outbox tables in baseline. Replay + compaction next phases. |
| GDPR / Compliance | Partial | Soft-delete + audit fields across major entities. |
| AI Orchestration | Placeholder | Future incremental adoption; no runtime impact yet. |
| Quality / Logistics / Payment / Others | Mostly placeholders | Represent forward roadmap – not part of baseline behavioral guarantees now. |

## Data Model Summary (Key Tables)
- `business_partners`: Canonical external entity representation; includes classification, hierarchy, capability JSON placeholder fields, audit metadata.
- `users`: Internal + external user identities with role/capability attachments.
- `roles`, `permissions`, `role_permissions`, `user_roles`: RBAC foundation.
- `event_outbox`, `events`: Durable event trail + async integration gateway.
- `organizations` + ancillary tables (`organization_bank_accounts`, `organization_document_series`, etc.).
- `commodities`, `commodity_parameters`, `commodity_varieties`, system parameter tables for matching logic.
- `settings_locations`: Reference geographic points (pincode/state/region) for trade scoping.
- `availabilities`, `requirements`: Core trade listing + demand representation.

All present tables are produced solely by the new clean baseline migration chain. Legacy divergent migrations were archived.

## Migrations
- **Old History:** Multiple merge heads, speculative indices, partially applied CDPS evolution script, partner table duplication.
- **Action Taken:** Full archival (`LEGACY_MIGRATIONS_ARCHIVED.md`). Introduced `alembic.ini` setting `version_locations = db/migrations/versions_clean`.
- **New Baseline:** Autogenerated and applied successfully to a clean PostgreSQL schema. Verified via upgrade + seed script run.
- **Operator Path for Existing Envs:** Export → Fresh DB → Apply baseline → Selective data import (mapping deprecated columns where necessary).

## Seed & Isolation Verification
Script: `backend/scripts/seed_isolation_test_data.py`
Creates:
- 1 organization (internal context).
- 3 business partners (buyer, seller, broker) fully aligned with canonical fields.
- 6 users (1 SUPER_ADMIN, 2 INTERNAL, 3 EXTERNAL) with module access arrays.

Isolation Tests (manual script `test_all_modules.py` earlier work):
1. DB connectivity (SELECT 1) – PASS.
2. Migrations presence – PASS (information_schema introspection).
3. Seed data counts – PASS.
4. Module file existence – PASS.
5. Middleware registration (Auth, RequestID, DataIsolation, SecureHeaders, Idempotency) – PASS.
6. Isolation component presence – PASS.

## Async Infrastructure Uniformity
- Removed legacy sync session artifacts.
- All repositories, scripts, and router dependencies now rely on `AsyncSessionLocal` provider.
- Readiness/health checks use async engine.

## Security & Compliance Snapshot
- Soft delete columns: `is_deleted`, `deleted_at`, `deleted_by`, reason fields across major entities.
- Minimal audit trail: `created_at`, `updated_at`, `created_by`, `updated_by`.
- Refresh tokens table present for session extension.
- OTP flows (via Redis) prepared; 2FA legacy migration removed; future reintroduction will version from baseline.

## Removed / Deferred (Will Reintroduce Strategically)
- Multi-column partner state/status indices referencing non-existent `primary_state` column.
- CDPS mass data transformation migration (rebuild via incremental changes – safer, testable slices).
- Performance GIN/text search indices: will add after measuring query patterns.
- Speculative risk validation migrations – replaced by explicit forward plan.

## Forward Roadmap (Next Phases)
1. Metrics & Profiling: Add p90/p99 latency instrumentation, then selective index migrations.
2. CDPS Incremental Evolution: Introduce capability flags gradually with backfill tasks instead of monolithic conversion.
3. Event Replay & DLQ Handling: Implement consumer confirmations + retry policies.
4. AI Layer Activation: Wire model selection orchestrator to business partner enrichment and quality detection.
5. Availability / Requirement Matching Optimization: Add partial indexes and materialized views if necessary.
6. Observability Enablement: Activate OTEL exporter; add structured logging correlation IDs.

## Build & Run Quickstart
```bash
# Backend
docker compose up -d postgres redis rabbitmq
export DATABASE_URL=postgresql://cotton_user:cotton_password@localhost:5432/cotton_erp
cd backend
python -m alembic upgrade head
python scripts/seed_isolation_test_data.py
uvicorn app.main:app --reload --port 8000
```

## Validation Commands
```bash
python scripts/test_all_modules.py
psql postgresql://cotton_user:cotton_password@localhost:5432/cotton_erp -c "\dt"
```

## Governance & Change Control
- All future schema changes MUST branch from `versions_clean`.
- Introduce one logical concern per migration (avoid multi-purpose speculative merges).
- Mandate runtime verification before documentation updates—this file remains source of truth.

## Reviewer Checklist (PRs Touching Architecture)
1. Does migration only address one bounded change?
2. Are async patterns preserved (no sync engine leakage)?
3. Are performance claims accompanied by profiling evidence?
4. Are soft-delete flows respected (no hard deletes unless purging policy)?
5. Is event outbox integration updated when adding domain events?

## Appendix A: Removed Legacy Docs
All former per-module and per-layer markdown documents replaced by this consolidated audit.

## Appendix B: Known Gaps
- Formal test suite coverage for partner hierarchy and outbox replay – pending.
- Full GDPR anonymization workflows – planned.
- Automated rollback strategy for failed partial migrations – design in progress.

---
Maintainers: Keep this lean; avoid speculative future sections—only code-verified state + approved roadmap.
